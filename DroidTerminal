import React, { useState, useRef, useEffect } from 'react';

interface ChatMessage {
  sender: 'user' | 'droid' | 'system';
  text: string;
  timestamp: string;
}

interface DroidTerminalProps {
  token: string;
}

declare function interactWithDroid(token: string, data: any): Promise<any>;
declare function parseUserIntent(message: string): Promise<any>;
declare const SendIcon: React.ComponentType;

const DroidTerminal: React.FC<DroidTerminalProps> = ({ token }: DroidTerminalProps) => {
  const [messages, setMessages] = useState<ChatMessage[]>([
    { sender: 'system', text: 'RillerDroid Assistant online. Ready for personalization input.', timestamp: new Date().toISOString() }
  ]);
  const [userInput, setUserInput] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const messagesEndRef = useRef<HTMLDivElement>(null);

  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  };

  useEffect(scrollToBottom, [messages]);

  const addMessage = (sender: 'user' | 'droid' | 'system', text: string) => {
    setMessages((prev: ChatMessage[]) => [...prev, { sender, text, timestamp: new Date().toISOString() }]);
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!userInput.trim() || isLoading) return;

    const userMessage = userInput;
    addMessage('user', userMessage);
    setUserInput('');
    setIsLoading(true);

    try {
      addMessage('system', 'Parsing intent with Gemini Core...');
      const parsedIntent = await parseUserIntent(userMessage);
      
      addMessage('system', 'Intent parsed. Transmitting to RillerDroid...');
      const droidResponse = await interactWithDroid(token, parsedIntent.structuredData);

      if (droidResponse.error) {
         addMessage('system', `// ERROR: ${droidResponse.error}`);
      } else {
         addMessage('droid', parsedIntent.conversationalResponse);
         addMessage('system', `Adaptability updated: ${droidResponse.adaptability}`);
      }

    } catch (error: any) {
      addMessage('system', `// ERROR: ${error.message}`);
    } finally {
      setIsLoading(false);
    }
  };

  return React.createElement('div', { className: "h-full flex flex-col" },
    React.createElement('div', { className: "flex-grow overflow-y-auto p-4 bg-[#010] border border-[#050] rounded-t-md" },
      messages.map((msg: ChatMessage, index: number) => 
        React.createElement('div', { key: index, className: "mb-3" },
          React.createElement('div', { className: "flex items-center text-xs opacity-70" },
            React.createElement('span', { 
              className: `font-bold ${
                msg.sender === 'user' ? 'text-cyan-400' : 
                msg.sender === 'droid' ? 'text-yellow-400' : 'text-red-500'
              }`
            }, msg.sender.toUpperCase()),
            React.createElement('span', { className: "ml-2 text-gray-500" }, new Date(msg.timestamp).toLocaleTimeString())
          ),
          React.createElement('p', { className: "text-sm whitespace-pre-wrap" }, msg.text)
        )
      ),
      React.createElement('div', { ref: messagesEndRef })
    ),
    React.createElement('form', { onSubmit: handleSubmit, className: "flex p-2 border-t border-[#050] bg-black rounded-b-md" },
      React.createElement('input', {
        type: "text",
        value: userInput,
        onChange: (e: React.ChangeEvent<HTMLInputElement>) => setUserInput(e.target.value),
        placeholder: isLoading ? "Awaiting response..." : "Tell me about your preferences...",
        disabled: isLoading,
        className: "flex-grow p-2 bg-[#010] border border-[#050] rounded-l-md focus:outline-none focus:border-[#0f0] focus:shadow-[0_0_5px_rgba(0,255,0,0.5)] transition-all duration-300"
      }),
      React.createElement('button', {
        type: "submit",
        disabled: isLoading || !userInput.trim(),
        className: "px-4 py-2 bg-[#050] rounded-r-md hover:bg-[#080] disabled:bg-[#030] disabled:cursor-not-allowed transition-colors",
        'aria-label': "Send Message"
      }, React.createElement(SendIcon))
    )
  );
};

export default DroidTerminal;
